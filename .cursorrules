# Project Laws

## Requirements
- The requirements are in @docs/specs/system_architecture.md - refer to this document when making plans. If a request is incompatible with one of the requirements, do not perform any actions until you have notified me and sought input.

## Postgres Only
Use PostgreSQL 16+ features (JSONB, TSVector, FOR UPDATE SKIP LOCKED). Never use SQLite.

## Test-Driven
- Every feature implementation MUST be accompanied by a pytest file using testcontainers-python.

- **Migration Verification:** Every time an Alembic migration is generated, a corresponding test in `tests/test_migrations.py` must be updated/added. 
- This test must:
  1. Use `testcontainers` to start a fresh Postgres instance.
  2. Run `alembic upgrade head` to verify the migration script is syntactically correct and respects Postgres 16 constraints.
  3. Run `alembic downgrade base` (or -1) to ensure the migration is reversible.

## Repository Pattern
Database access must be abstracted into Repository classes. No ORM calls in business logic.

## BaseWorker Hook
All workers must inherit from BaseWorker and implement handle_signal(command).

## Environment
- The development environment is using uv so any time a command is given that requires uv (whether executed by you or displayed for me), ensure that the full uv command is shown.

- Anytime the uv sync command is run (or shared as a command for the viewer to run manually), be sure to include all extras to avoid removing the dev environment.

## Data Rules
- All timestamps in the database should be with timezone - we never store data in local time (though we may display it in local time)

## Documentation
- When new entities, CLI commands, or UI changes are made, update the user guide files in docs/specs: api_user_guide.md, cli_user_guide.md, ui_user_guide.md, video_extraction_user_guide.md (check for other guides if none of these are relevant)

- While planning, if a change would be counter to a described state, design, behavior, etc in any of the docs under the docs/specs folder, notify me to confirm that the spec should be updated or if the plan is out of spec.
